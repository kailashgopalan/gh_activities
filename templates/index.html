<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Habit Tracker - Welcome, {{ user_name }}!</h1>
            <div>
                {% if is_admin %}
                <a href="{{ url_for('admin_query') }}" class="btn btn-warning me-2">Admin Query</a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">Logout</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('index') }}">
            <input type="hidden" name="action" value="add_activity">
            <input type="text" name="description" placeholder="Activity" required>
            <select name="habit_id">
                <option value="">Auto-classify</option>
                {% for habit in habits %}
                    <option value="{{ habit.id }}">{{ habit.name }} {{ habit.emoji }}</option>
                {% endfor %}
            </select>
            <input type="number" name="hours" step="0.1" min="0" max="24" placeholder="Hours" required>
            <button type="submit" class="btn btn-primary">Log Activity</button>
        </form>

        <h2 class="mt-4">Activity Grid</h2>
        <div class="activity-grid" id="activityGrid"></div>

        <h2 class="mt-4">Daily Activities</h2>
        <div class="date-navigation d-flex justify-content-between mb-3">
            <button id="prevDay" class="btn btn-secondary">&lt; Previous Day</button>
            <span id="currentDate">{{ current_date.strftime('%Y-%m-%d') }}</span>
            <button id="nextDay" class="btn btn-secondary">Next Day &gt;</button>
        </div>
        <div id="activityLog" class="activity-log">
            {% for activity in activities %}
            <div class="activity-item">
                <div class="activity-content">
                    <strong>{{ activity.description }}</strong>
                    <span class="category {{ activity.habit_name }}">
                        {{ activity.habit_name }} {{ activity.emoji }}
                    </span>
                    <span class="hours">{{ activity.hours }} hours</span>
                    <a href="{{ url_for('edit_activity', activity_id=activity.id) }}" class="btn btn-primary btn-sm">Edit</a>
                </div>
            </div>
            {% endfor %}
        </div>

        <h2 class="mt-4">Add New Habit</h2>
        <form method="POST" action="{{ url_for('index') }}">
            <input type="hidden" name="action" value="add_habit">
            <div class="mb-3">
                <input type="text" name="habit_name" class="form-control" placeholder="Enter new habit name" required>
            </div>
            <button type="submit" class="btn btn-primary">Add Habit</button>
        </form>

        <h2 class="mt-4">Summary</h2>
        <div class="summary-tabs">
            <ul class="nav nav-tabs" id="summaryTabs" role="tablist">
                {% for habit in summary %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if loop.first %}active{% endif %}" id="tab-{{ habit.habit|replace(' ', '_') }}" data-bs-toggle="tab" data-bs-target="#content-{{ habit.habit|replace(' ', '_') }}" type="button" role="tab">
                        {{ habit.emoji }} {{ habit.habit }}
                    </button>
                </li>
                {% endfor %}
            </ul>
            <div class="tab-content" id="summaryTabsContent">
                {% for habit in summary %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="content-{{ habit.habit|replace(' ', '_') }}" role="tabpanel">
                    <canvas id="chart-{{ habit.habit|replace(' ', '_') }}"></canvas>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const gridData = JSON.parse('{{ grid_data|tojson|safe }}');
        const grid = document.getElementById('activityGrid');

        gridData.forEach(item => {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.style.backgroundColor = `rgba(40, 167, 69, ${item.hours / 10 > 1 ? 1 : item.hours / 10})`;
            
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = `<strong>${item.date}</strong><br>Total: ${item.hours.toFixed(1)} hours<br>${item.summary.join('<br>')}`;
            
            cell.appendChild(tooltip);
            grid.appendChild(cell);
        });

        // Date navigation
        const prevDayBtn = document.getElementById('prevDay');
        const nextDayBtn = document.getElementById('nextDay');
        const currentDateSpan = document.getElementById('currentDate');
        const activityLog = document.getElementById('activityLog');

        let currentDate = new Date('{{ current_date }}');

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function updateActivityLog(date) {
            fetch(`/activities/${formatDate(date)}`)
                .then(response => response.json())
                .then(activities => {
                    activityLog.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-content">
                                <strong>${activity.description}</strong>
                                <span class="category ${activity.habit_name}">
                                    ${activity.habit_name} ${activity.emoji}
                                </span>
                                <span class="hours">${activity.hours} hours</span>
                                <a href="/edit/${activity.id}" class="btn btn-primary btn-sm">Edit</a>
                            </div>
                        </div>
                    `).join('');
                });
        }

        prevDayBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 1);
            currentDateSpan.textContent = formatDate(currentDate);
            updateActivityLog(currentDate);
        });

        nextDayBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 1);
            currentDateSpan.textContent = formatDate(currentDate);
            updateActivityLog(currentDate);
        });

        // Chart.js code
        {% for habit, data in habit_data.items() %}
        new Chart(document.getElementById('chart-{{ habit|replace(' ', '_') }}').getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ data['dates']|tojson }},
                datasets: [{
                    label: 'Hours',
                    data: {{ data['hours']|tojson }},
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        {% endfor %}
    </script>
</body>
</html>