<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .habit-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .habit-item {
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-bottom: 20px;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #ccc;
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .activity-table th, .activity-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .activity-table th {
            background-color: #f2f2f2;
        }
        .activity-group {
            background-color: #f9f9f9;
        }
        .edit-form {
            display: none;
        }
        form {
            margin-bottom: 20px;
        }
        input[type="text"], input[type="number"], select, button {
            margin: 5px 0;
            padding: 5px;
        }
        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .date-nav button {
            padding: 5px 10px;
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>Activity Tracker</h1>
    
    {% if 'user_id' in session %}
        <p>Welcome, {{ session.get('name', 'User') }}! 
            <a href="{{ url_for('logout') }}">Logout</a>
            {% if is_admin %}
   |            <a href="{{ url_for('admin') }}">Admin Query</a>
            {% endif %}
        </p>
        
        <h2>Add New Habit</h2>
        <form action="{{ url_for('index') }}" method="post">
            <input type="hidden" name="action" value="add_habit">
            <input type="text" name="habit_name" placeholder="New habit name" required>
            <button type="submit">Add Habit</button>
        </form>

        <h2>Your Habits</h2>
        <div class="habit-list">
            {% for habit in habits %}
                <div class="habit-item">{{ habit.emoji }} {{ habit.name }}</div>
            {% endfor %}
        </div>

        <h2>Log Activity</h2>
        <form id="addActivityForm">
            <select name="habit_id">
                <option value="">Auto-classify</option>
                {% for habit in habits %}
                    <option value="{{ habit.id }}">{{ habit.emoji }} {{ habit.name }}</option>
                {% endfor %}
            </select>
            <input type="text" name="description" placeholder="Activity description" required>
            <input type="number" name="hours" step="0.1" min="0" placeholder="Hours" required>
            <input type="date" name="activity_date">
            <button type="submit">Log Activity</button>
        </form>
        
        <h2>Activity Grid</h2>
        <p>Days with logged habits: <span id="totalDays">0</span></p>
        <div class="activity-grid-container" style="border: 2px solid black;">
            <div id="activityGrid" class="activity-grid"></div>
        </div>
        <div class="tooltip" id="tooltip"></div>
        
        <h2>Activity Log</h2>
        <div class="date-nav">
            <button onclick="changeDate(-1)">Previous Day</button>
            <span id="currentDate">{{ current_date.strftime('%Y-%m-%d') }}</span>
            <button onclick="changeDate(1)">Next Day</button>
        </div>
        <table class="activity-table">
            <thead>
                <tr>
                    <th>Habit</th>
                    <th>Description</th>
                    <th>Hours</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="activityLog">
                <!-- Activities will be inserted here by JavaScript -->
            </tbody>
        </table>

        <h2>Summary Charts</h2>
        <div class="tab">
            {% for habit in habits %}
                <button class="tablinks" onclick="openChart(event, 'chart{{ habit.id }}')">{{ habit.emoji }} {{ habit.name }}</button>
            {% endfor %}
        </div>

        {% for habit in habits %}
            <div id="chart{{ habit.id }}" class="tabcontent">
                <canvas id="summaryChart{{ habit.id }}"></canvas>
            </div>
        {% endfor %}

        <script>
            let currentDate = new Date('{{ current_date.isoformat() }}');
            function changeDate(days) {
                currentDate.setDate(currentDate.getDate() + days);
                document.getElementById('currentDate').textContent = currentDate.toISOString().split('T')[0];
                fetchActivities(currentDate);
            }

            function fetchActivities(date) {
                fetch(`/activities/${date.toISOString().split('T')[0]}`)
                    .then(response => response.json())
                    .then(activities => {
                        const activityLog = document.getElementById('activityLog');
                        activityLog.innerHTML = ''; // Clear previous activities
                        const groupedActivities = groupActivitiesByHabit(activities);
                    
                    for (const [habit, habitActivities] of Object.entries(groupedActivities)) {
                        const habitRow = document.createElement('tr');
                        habitRow.className = 'activity-group';
                        habitRow.innerHTML = `
                            <td colspan="4"><strong><em>${habit}</em></strong></td>
                        `;
                        activityLog.appendChild(habitRow);

                        habitActivities.forEach(activity => {
                            const activityRow = document.createElement('tr');
                            activityRow.innerHTML = `
                                <td>${activity.emoji}</td>
                                <td>${activity.description}</td>
                                <td>${activity.hours}</td>
                                <td>
                                    <button onclick="showEditForm(${activity.id})">Edit</button>
                                    <form id="editForm${activity.id}" class="edit-form" onsubmit="return updateActivity(${activity.id})">
                                        <select name="habit_id" required>
                                            ${habits.map(h => `<option value="${h.id}" ${h.id === activity.habit_id ? 'selected' : ''}>${h.emoji} ${h.name}</option>`).join('')}
                                        </select>
                                        <input type="text" name="description" value="${activity.description}" required>
                                        <input type="number" name="hours" value="${activity.hours}" step="0.1" min="0" required>
                                        <button type="submit">Save</button>
                                        <button type="button" onclick="hideEditForm(${activity.id})">Cancel</button>
                                    </form>
                                </td>
                            `;
                            activityLog.appendChild(activityRow);
                        });
                    }
                });
        }

            // Initial fetch of activities
            fetchActivities(currentDate);

            // Chart.js code for summary charts
            {% for habit in habits %}
                const ctx{{ habit.id }} = document.getElementById('summaryChart{{ habit.id }}').getContext('2d');
                new Chart(ctx{{ habit.id }}, {
                    type: 'bar',
                    data: {
                        labels: {{ habit_data[habit.name]['dates']|tojson }},
                        datasets: [{
                            label: 'Total Hours',
                            data: {{ habit_data[habit.name]['hours']|tojson }},
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Hours'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Hours: ${context.raw.toFixed(1)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            {% endfor %}

            function openChart(evt, chartName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(chartName).style.display = "block";
                evt.currentTarget.className += " active";
            }

            function groupActivitiesByHabit(activities) {
                return activities.reduce((groups, activity) => {
                    const habitName = activity.habit_name;
                    if (!groups[habitName]) {
                        groups[habitName] = [];
                    }
                    groups[habitName].push(activity);
                    return groups;
                }, {});
            }

            function showEditForm(activityId) {
                document.getElementById(`editForm${activityId}`).style.display = 'block';
            }

            function hideEditForm(activityId) {
                document.getElementById(`editForm${activityId}`).style.display = 'none';
            }

            function updateActivity(activityId) {
                const form = document.getElementById(`editForm${activityId}`);
                const habit_id = form.elements['habit_id'].value;
                const description = form.elements['description'].value;
                const hours = form.elements['hours'].value;

                fetch(`/update_activity/${activityId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ habit_id, description, hours }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Activity updated successfully');
                        fetchActivities(currentDate); // Refresh the activity log
                    } else {
                        alert('Failed to update activity');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the activity');
                });

                return false; // Prevent form submission
            }

            function refreshData() {
                Promise.all([
                    fetch('/activity_grid_data').then(response => response.json()),
                    fetch('/habit_data').then(response => response.json())
                ])
                .then(([gridData, habitData]) => {
                    createActivityGrid(gridData);
                    updateCharts(habitData);
                })
                .catch(error => console.error('Error refreshing data:', error));
            }

            function updateCharts(habitData) {
                for (const [habitName, data] of Object.entries(habitData)) {
                    const chartId = `summaryChart${data.id}`;
                    const ctx = document.getElementById(chartId).getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.chartInstances && window.chartInstances[chartId]) {
                        window.chartInstances[chartId].destroy();
                    }

                    // Create new chart
                    window.chartInstances = window.chartInstances || {};
                    window.chartInstances[chartId] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: 'Hours',
                                data: data.hours,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }
            function updateActivityLog(activities) {
                const activityLog = document.getElementById('activityLog');
                activityLog.innerHTML = ''; // Clear existing activities

                const groupedActivities = groupActivitiesByHabit(activities);
                
                for (const [habit, habitActivities] of Object.entries(groupedActivities)) {
                    const habitRow = document.createElement('tr');
                    habitRow.className = 'activity-group';
                    habitRow.innerHTML = `
                        <td colspan="5"><strong><em>${habit}</em></strong></td>
                    `;
                    activityLog.appendChild(habitRow);

                    habitActivities.forEach(activity => {
                        const activityRow = document.createElement('tr');
                        activityRow.innerHTML = `
                            <td>${activity.emoji}</td>
                            <td>${activity.description}</td>
                            <td>${activity.hours}</td>
                            <td>
                                <button onclick="showEditForm(${activity.id})">Edit</button>
                                <button onclick="deleteActivity(${activity.id})">Delete</button>
                                <form id="editForm${activity.id}" class="edit-form" onsubmit="return updateActivity(${activity.id})">
                                    <input type="text" name="description" value="${activity.description}" required>
                                    <input type="number" name="hours" value="${activity.hours}" step="0.1" min="0" required>
                                    <button type="submit">Save</button>
                                    <button type="button" onclick="hideEditForm(${activity.id})">Cancel</button>
                                </form>
                            </td>
                        `;
                        activityLog.appendChild(activityRow);
                    });
                }
            }
            function deleteActivity(activityId) {
                if (confirm('Are you sure you want to delete this activity?')) {
                    fetch(`/delete_activity/${activityId}`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Activity deleted successfully');
                            refreshData();
                        } else {
                            alert('Failed to delete activity: ' + data.message);
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the activity');
                    });
                }
            }
            function refreshData() {
                Promise.all([
                    fetch('/activity_grid_data').then(response => response.json()),
                    fetch('/habit_data').then(response => response.json()),
                    // fetch('/activities/' + getCurrentDate()).then(response => response.json())
                ])
                .then(([gridData, habitData, activityData]) => {
                    createActivityGrid(gridData);
                    updateCharts(habitData);
                    // updateActivityLog(activityData);
                })
                .catch(error => console.error('Error refreshing data:', error));
            }

            function createActivityGrid(gridData) {
                const grid = document.getElementById('activityGrid');
                const tooltip = document.getElementById('tooltip');
                let totalDays = 0;

                grid.innerHTML = ''; // Clear existing cells

                // Calculate the number of weeks
                const weeks = Math.ceil(gridData.length / 7);

                gridData.forEach((day, index) => {
                    const cell = document.createElement('div');
                    cell.className = 'activity-cell';
                    
                    // Set default background color
                    cell.style.width = '30px';
                    cell.style.height = '30px';
                    cell.style.display = 'inline-block';
                    cell.style.backgroundColor = '#ebedf0';
                    cell.style.border = '1px solid #fff';
                    
                    if (day.hours > 0) {
                        const intensity = Math.min(day.hours / 5, 1);
                        cell.style.backgroundColor = `rgba(0, 128, 0, ${intensity})`;
                        totalDays++;
                    }

                    cell.addEventListener('mouseover', (e) => {
                        const rect = e.target.getBoundingClientRect();
                        const gridRect = grid.getBoundingClientRect();
    
                        let left = rect.left - gridRect.left + grid.scrollLeft;
                        let top = rect.bottom - gridRect.top + grid.scrollTop + 5;

                        // Adjust if tooltip would extend beyond the right edge
                        if (left + 220 > gridRect.width) {
                            left = gridRect.width - 225;
                        }
                        tooltip.style.left = `${left}px`;
                        tooltip.style.top = `${top}px`;

                        // Group hours by habit
                        const habitSummary = day.summary.reduce((acc, activity) => {
                            const [habit, hours] = activity.split(': ');
                            acc[habit] = (acc[habit] || 0) + parseFloat(hours);
                            return acc;
                        }, {});

                        // Create tooltip content
                        let tooltipContent = `<strong>${day.date}</strong><br>Total Hours: ${day.hours.toFixed(1)}<br><br>`;
                        for (const [habit, hours] of Object.entries(habitSummary)) {
                            tooltipContent += `${habit}: ${hours.toFixed(1)} hours<br>`;
                        }

                        tooltip.innerHTML = tooltipContent;
                        tooltip.style.display = 'block';
                        tooltip.style.border = '1px solid #333';
                    });

                    cell.addEventListener('mouseout', () => {
                        tooltip.style.display = 'none';
                    });

                    grid.appendChild(cell);
                });

                document.getElementById('totalDays').textContent = totalDays;

                console.log(`Grid created with ${gridData.length} cells in ${weeks} weeks. Total active days: ${totalDays}`);
            }

            
            // Open the first tab by default
            document.getElementsByClassName("tablinks")[0].click();
            
            document.getElementById('addActivityForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const activityDate = formData.get('activity_date') || new Date().toISOString().split('T')[0];
                
                fetch('/add_activity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        habit_id: formData.get('habit_id') || null,  // Send null if no habit is selected
                        description: formData.get('description'),
                        hours: formData.get('hours'),
                        date: activityDate
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Activity added successfully');
                        this.reset();
                        refreshData();
                    } else {
                        alert('Failed to add activity: ' + data.message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('An error occurred while adding the activity');
                });
            });

            // Set default date to today
            document.addEventListener('DOMContentLoaded', function() {
                const today = new Date().toISOString().split('T')[0];
                document.querySelector('input[name="activity_date"]').value = today;
            });
            

            // Call this function when the page loads
            document.addEventListener('DOMContentLoaded', () => {
                refreshData();
                console.log('DOM content loaded, fetching grid data'); // Debugging line
                fetch('/activity_grid_data')
                    .then(response => response.json())
                    .then(data =>  {
                        console.log('Grid data fetched:', data); // Debugging line
                        createActivityGrid(data);
                    })
                    .catch(error => console.error('Error fetching grid data:', error)); // Error handling
            });
        </script>
    {% if is_admin %}
        <script>
            const habits = {{ habits_json|safe }};
            document.getElementById('adminQueryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const query = this.elements['query'].value;
                fetch('/admin/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query }),
                })
                .then(response => response.json())
                .then(data => {
                    const resultDiv = document.getElementById('queryResult');
                    if (data.error) {
                        resultDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                    } else {
                        let resultHtml = '<table border="1"><tr>';
                        // Add table headers
                        for (let key in data.results[0]) {
                            resultHtml += `<th>${key}</th>`;
                        }
                        resultHtml += '</tr>';
                        // Add table rows
                        data.results.forEach(row => {
                            resultHtml += '<tr>';
                            for (let key in row) {
                                resultHtml += `<td>${row[key]}</td>`;
                            }
                            resultHtml += '</tr>';
                        });
                        resultHtml += '</table>';
                        resultDiv.innerHTML = resultHtml;
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    document.getElementById('queryResult').innerHTML = `<p style="color: red;">An error occurred while running the query</p>`;
                });
            });
        </script>
    {% endif %}
    {% else %}
        <p>Please <a href="{{ url_for('login') }}">login</a> to use the Activity Tracker.</p>
    {% endif %}
</body>
</html>